name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

    - name: Build for Debug
      run: xcodebuild -project xAI-Balance-Menu.xcodeproj -scheme "xAI-Balance-Menu" -configuration Debug build

    - name: Build for Release
      run: xcodebuild -project xAI-Balance-Menu.xcodeproj -scheme "xAI-Balance-Menu" -configuration Release build

    - name: Create DMG
      if: github.event_name == 'release'
      run: |
        # Install create-dmg if needed
        brew install create-dmg

        # Create DMG from Release build
        create-dmg \
          --volname "xAI Balance Menu" \
          --volicon "xAI_Logo.svg" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "xAI-Balance-Menu.app" 200 190 \
          --hide-extension "xAI-Balance-Menu.app" \
          --app-drop-link 600 185 \
          "xAI-Balance-Menu.dmg" \
          "build/Release/xAI-Balance-Menu.app"

    - name: Upload Release Assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: xAI-Balance-Menu.dmg
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        run: |
          # Check available Xcode versions
          ls -la /Applications/ | grep Xcode

          # Use the default Xcode (should be latest available)
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Verify Xcode version
        run: |
          xcodebuild -version
          echo "macOS version:"
          sw_vers

      - name: Build for Debug
        run: |
          xcodebuild -project xAI-Balance-Menu.xcodeproj -scheme "xAI-Balance-Menu" -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build 2>&1 | tail -20

      - name: Run Tests with Code Coverage
        run: |
          xcodebuild test -project xAI-Balance-Menu.xcodeproj -scheme "xAI-Balance-Menu" \
            -destination 'platform=macOS' \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO || true

      - name: Check if TestResults exists
        id: check-results
        run: |
          if [ -d "TestResults.xcresult" ]; then
            echo "results_found=true" >> $GITHUB_OUTPUT
            echo "Coverage data found"
          else
            echo "results_found=false" >> $GITHUB_OUTPUT
            echo "No coverage data found"
          fi

      - name: Convert Coverage to Codecov Format
        if: steps.check-results.outputs.results_found == 'true'
        run: |
          xcrun xccov view --report --json TestResults.xcresult > coverage.json || echo "Failed to generate coverage JSON"

      - name: Upload to Codecov
        if: steps.check-results.outputs.results_found == 'true'
        uses: codecov/codecov-action@v4
        with:
          files: coverage.json
          flags: unittests
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Build for Release
        run: |
          xcodebuild -project xAI-Balance-Menu.xcodeproj -scheme "xAI-Balance-Menu" -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build 2>&1 | tail -20
